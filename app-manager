#!/bin/bash

# Author: Dillrex
# Contributors: Quadsam

UPSTREAM_URL="https://raw.githubusercontent.com/Dillrex/APP-Manager/refs/heads/main"
VERSION=06

# List installed apps
list_installed_apps() {
    dpkg-query -f '${binary:Package}\n' -W | grep -vE "linux|^lib|^firmware|^systemd|^dpkg|^apt|^bash|^glibc|^python" | sort
}

# Search and select app
search_and_select_app() {
    local apps=$(list_installed_apps)
    if [ -z "$apps" ]; then
        zenity --info --text="No installed apps found!" --title="App Manager"
        echo ""
        return
    fi

    local search_term=""
    while true; do
        search_term=$(zenity --entry --title="App Manager - Search Apps" \
            --text="Enter a search term (or leave empty to list all apps):")

        if [ $? -ne 0 ]; then
            echo ""
            return
        fi

        local filtered_apps=$(echo "$apps" | grep -i "$search_term")
        if [ -z "$filtered_apps" ]; then
            zenity --warning --text="No apps found matching '$search_term'. Try again." --title="App Manager"
            continue
        fi

        local selected_app=$(zenity --list --title="App Manager - Select an App" \
            --text="Select an app from the list." --column="Installed Apps" $(echo "$filtered_apps"))

        if [ -z "$selected_app" ]; then
            zenity --info --text="No app selected. Returning to the main menu." --title="App Manager"
            echo ""
            return
        fi

        echo "$selected_app"
        return
    done
}

# Update a specific app
update_app() {
    local selected_app=$(search_and_select_app)
    if [ -z "$selected_app" ]; then
        return
    fi

    if zenity --question --text="Are you sure you want to update $selected_app?" --title="App Manager - Update"; then
        sudo apt-get install --only-upgrade -y "$selected_app"
        if [ $? -eq 0 ]; then
            zenity --info --text="$selected_app has been successfully updated." --title="App Manager - Update"
        else
            zenity --error --text="Failed to update $selected_app. Check for errors." --title="App Manager - Update"
        fi
    fi
}

# Update all installed apps
update_all_apps() {
    if zenity --question --text="This will update all installed apps. Proceed?" --title="App Manager - Update All"; then
        sudo apt-get update && sudo apt-get upgrade -y
        if [ $? -eq 0 ]; then
            zenity --info --text="All apps have been successfully updated." --title="App Manager - Update All"
        else
            zenity --error --text="Failed to update some apps. Check for errors." --title="App Manager - Update All"
        fi
    fi
}

# Interactive mode
interactive_mode() {
    while true; do
        action=$(zenity --list \
            --title="App Manager - Interactive Mode" \
            --text="Select an action:" \
            --column="Action" --column="Description" \
            "Install App" "Install an app by selecting a file" \
            "List Apps" "View and search installed applications" \
            "Uninstall App" "Search and uninstall an app" \
            "Check for Updates" "Check for and install the latest version of App Manager" \
            "Update App" "Update a specific installed app" \
            "Update All" "Update all installed apps to the latest version" \
            --width=800 --height=600)

        if [ -z "$action" ]; then
            zenity --info --text="Exiting Interactive Mode." --title="App Manager"
            break
        fi

        case "$action" in
            "Install App") install_from_gui ;;
            "List Apps") search_and_select_app ;;
            "Uninstall App") uninstall_from_gui ;;
            "Check for Updates") check_for_updates ;;
            "Update App") update_app ;;
            "Update All") update_all_apps ;;
            *) zenity --error --text="Invalid option." --title="App Manager" ;;
        esac
    done
}

# Check for script updates
check_for_updates() {
    upstream_version=$(curl -fs "$UPSTREAM_URL/version.txt")

    if [[ -z $upstream_version ]]; then
        zenity --error --text="Failed to fetch upstream version!" --title="App Manager - Update"
        return 1
    fi

    if [[ $VERSION -lt $upstream_version ]]; then
        if zenity --question --text="An update is available ($upstream_version). Install it? (Script will restart)" --title="App Manager - Update"; then
            if ! curl -#o '/tmp/app-manager.update' "$UPSTREAM_URL/app-manager"; then
                zenity --error --text="Download failed! Check your internet connection." --title="App Manager - Update"
                return 1
            fi

            # Use sudo to handle permission issues
            exec bash -c "sudo mv /tmp/app-manager.update $(realpath $0) && sudo chmod +x $(realpath $0) && exec $(realpath $0)"
        else
            zenity --info --text="Update skipped. You can check again later." --title="App Manager - Update"
        fi
    else
        zenity --info --text="You are using the latest version of App Manager." --title="App Manager - Update"
    fi
}


# Main logic
if [ -z "$1" ]; then
    show_help
    exit 1
fi

case "$1" in
    i) interactive_mode ;;
    update-app) update_app ;;
    update-all) update_all_apps ;;
    update) check_for_updates ;;
    help) show_help ;;
    *) echo "Unknown command: $1"; show_help ;;
esac
