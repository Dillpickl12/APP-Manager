#!/bin/bash

# Author: Dillrex (Dylan)

install_deb() {
    local deb_file="$1"
    if [ -f "$deb_file" ]; then
        zenity --info --text="Installing $deb_file..." --title="App Manager"
        sudo dpkg -i "$deb_file" && sudo apt-get install -f -y
        if [ $? -eq 0 ]; then
            zenity --info --text="Installation of $deb_file completed successfully!" --title="App Manager"
        else
            zenity --error --text="Error during the installation of $deb_file." --title="App Manager"
        fi
    else
        zenity --error --text="Error: File '$deb_file' not found." --title="App Manager"
    fi
}

install_tarball() {
    local tar_file="$1"
    if [ -f "$tar_file" ]; then
        zenity --info --text="Extracting and installing $tar_file..." --title="App Manager"
        tar -xf "$tar_file" -C /opt
        cd /opt/$(basename "$tar_file" .tar.*) && sudo ./install.sh
        if [ $? -eq 0 ]; then
            zenity --info --text="Installation of $tar_file completed successfully!" --title="App Manager"
        else
            zenity --error --text="Error during the installation of $tar_file." --title="App Manager"
        fi
    else
        zenity --error --text="Error: File '$tar_file' not found." --title="App Manager"
    fi
}

install_from_gui() {
    local file=$(zenity --file-selection --title="Select a .deb or tarball file to install")
    if [[ "$file" == *.deb ]]; then
        install_deb "$file"
    elif [[ "$file" == *.tar.gz || "$file" == *.tar.xz || "$file" == *.tar.bz2 ]]; then
        install_tarball "$file"
    else
        zenity --error --text="Unsupported file type for installation. Please select a .deb or tarball file." --title="App Manager"
    fi
}

list_installed_apps() {
    dpkg-query -f '${binary:Package}\n' -W | grep -vE "linux|^lib|^firmware|^systemd|^dpkg|^apt|^bash|^glibc|^python" | sort
}

uninstall_from_gui() {
    local installed_apps=$(list_installed_apps)
    if [ -z "$installed_apps" ]; then
        zenity --info --text="No installed apps found!" --title="App Manager"
        return
    fi

    local selected_app=$(echo "$installed_apps" | zenity --list \
        --title="Select an App to Uninstall" \
        --text="Select an app to uninstall:" \
        --column="Installed Apps" \
        --height=400 \
        --width=600)

    if [ -n "$selected_app" ]; then
        if zenity --question --text="Are you sure you want to uninstall $selected_app?" --title="App Manager"; then
            sudo apt-get remove --purge -y "$selected_app" && sudo apt-get autoremove -y
            if [ $? -eq 0 ]; then
                zenity --info --text="$selected_app has been successfully uninstalled." --title="App Manager"
            else
                zenity --error --text="Error uninstalling $selected_app." --title="App Manager"
            fi
        fi
    else
        zenity --error --text="No app selected for uninstallation." --title="App Manager"
    fi
}

interactive_mode() {
    while true; do
        action=$(zenity --list \
            --title="App Manager - Interactive Mode" \
            --text="Select an action:" \
            --column="Action" --column="Description" \
            "Install App" "Install an app by selecting a file" \
            "List Apps" "View installed applications" \
            "Uninstall App" "Select and uninstall an app" \
            "Exit" "Exit interactive mode")

        case "$action" in
            "Install App")
                install_from_gui
                ;;
            "List Apps")
                local apps=$(list_installed_apps)
                if [ -z "$apps" ]; then
                    zenity --info --text="No apps found!" --title="App Manager"
                else
                    zenity --text-info --title="Installed Apps" --filename=<(echo "$apps")
                fi
                ;;
            "Uninstall App")
                uninstall_from_gui
                ;;
            "Exit")
                zenity --info --text="Exiting Interactive Mode." --title="App Manager"
                break
                ;;
            *)
                zenity --error --text="Invalid option." --title="App Manager"
                ;;
        esac
    done
}

show_help() {
    echo "Available commands:"
    echo "  installapp <file|URL>        Install an app from a file or URL"
    echo "  listapps                     List installed apps by category"
    echo "  uninstallapp <app_name>      Uninstall an app or category"
    echo "  interactive                  Launch GUI-based interactive mode"
    echo "  help                         Show this help message"
}

if [ -z "$1" ]; then
    show_help
    exit 1
fi

case "$1" in
    installapp)
        install_from_url "$2"
        ;;
    listapps)
        list_installed_apps
        ;;
    uninstallapp)
        uninstall_app "$2"
        ;;
    interactive)
        interactive_mode
        ;;
    help)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        ;;
esac
